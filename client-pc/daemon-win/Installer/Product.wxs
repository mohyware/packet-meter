<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">
  <Package Name="PacketMeter"
           Version="1.0.0"
           Manufacturer="PacketMeter"
           UpgradeCode="A1B2C3D4-E5F6-7890-ABCD-EF1234567890"
           Compressed="yes">
    <?define DaemonSourceDir = "..\Daemon\bin\Release\net9.0-windows10.0.19041.0\win-x64\publish" ?>
    <?define UISourceDir = "..\UI\bin\Release\net9.0-windows10.0.19041.0\win-x64\publish" ?>

    <!-- TODO: Add icon and URL info to the installer -->
    <!-- <Property Id="ARPPRODUCTICON" Value="ProductIcon" /> -->
    <Property Id="ARPURLINFOABOUT" Value="https://mohy.dev" />
    <Property Id="ARPNOREPAIR" Value="yes" />
    <!-- <Icon Id="" SourceFile="" /> -->

    <MediaTemplate EmbedCab="yes"/>

    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />

    <!-- Define installation directory -->
    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="PacketMeter">
        <Directory Id="DaemonFolder" Name="Daemon" />
        <Directory Id="UIFolder" Name="UI" />
      </Directory>
    </StandardDirectory>

    <!-- Daemon executable with service installation -->
    <ComponentGroup Id="DaemonFiles" Directory="DaemonFolder">
      <Component>
        <File Source="$(var.DaemonSourceDir)\packetmeter-daemon.exe" KeyPath="yes" />
        <ServiceInstall Name="PacketMeterDaemon"
                        DisplayName="PacketMeter Daemon"
                        Description="PacketMeter network monitoring daemon service"
                        Start="auto"
                        Account="LocalSystem"
                        ErrorControl="normal"
                        Interactive="no">
          <ServiceDependency Id="Tcpip" />
        </ServiceInstall>
        <ServiceControl Name="PacketMeterDaemon"
                        Start="install"
                        Stop="both"
                        Remove="uninstall"
                        Wait="yes" />
      </Component>
    </ComponentGroup>

    <!-- If Ui proj published as a single file -->
   <!-- <ComponentGroup Id="UIFiles" Directory="UIFolder">
      <Component>
        <File Source="$(var.UISourceDir)\PacketMeter.UI.exe" KeyPath="yes" />
      </Component>
    </ComponentGroup> -->

    <!-- Desktop Shortcut -->
    <StandardDirectory Id="DesktopFolder" />
        <ComponentGroup Id="Shortcuts" Directory="DesktopFolder">
          <Component Id="DesktopShortcut" Guid="e16a841a-8127-461f-821b-56287203179a">
            <Shortcut Id="DesktopShortcut"
                      Name="PacketMeter"
                      Description="PacketMeter Network Monitor"
                      Target="[UIFolder]PacketMeter.UI.exe"
                      WorkingDirectory="UIFolder" />
            <RegistryValue Root="HKCU" 
                          Key="Software\PacketMeter" 
                          Name="DesktopShortcut" 
                          Type="integer" 
                          Value="1" 
                          KeyPath="yes" />
          </Component>
        </ComponentGroup>

    <!-- Start Menu Shortcut -->
    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ApplicationProgramsFolder" Name="PacketMeter" />
    </StandardDirectory>
    <ComponentGroup Id="StartMenuShortcuts" Directory="ApplicationProgramsFolder">
      <Component Id="StartMenuShortcut" Guid="e16a841a-8127-461f-821b-56287208179a">
        <Shortcut Id="StartMenuShortcut"
                  Name="PacketMeter"
                  Description="PacketMeter Network Monitor"
                  Target="[UIFolder]PacketMeter.UI.exe"
                  WorkingDirectory="UIFolder" />
        <RemoveFolder Id="ApplicationProgramsFolder" On="uninstall" />
        <RegistryValue Root="HKCU" 
                      Key="Software\PacketMeter" 
                      Name="StartMenuShortcut" 
                      Type="integer" 
                      Value="1" 
                      KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- Feature definitions -->
    <Feature Id="ProductFeature" Title="PacketMeter" Level="1">
      <ComponentGroupRef Id="DaemonFiles" />
      <ComponentGroupRef Id="UIFiles" />
      <ComponentGroupRef Id="Shortcuts" />
      <ComponentGroupRef Id="StartMenuShortcuts" />
    </Feature>

  </Package>
</Wix>
